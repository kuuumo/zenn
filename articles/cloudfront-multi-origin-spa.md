---
title: "[AWS CloudFront] è¤‡æ•°ã®SPAã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒãƒ«ãƒã‚ªãƒªã‚¸ãƒ³ã§é…ä¿¡ã™ã‚‹éš›ã®æ³¨æ„ç‚¹"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [AWS, CloudFront, S3, SPA, Lambda@edge]
published: true
---

## ã¯ã˜ã‚ã«

AWSã®S3ã¨CloudFrontã‚’ä½¿ç”¨ã—ã¦è¤‡æ•°ã®ã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSPAï¼‰ã‚’é…ä¿¡ã™ã‚‹éš›ã€åŠ¹ç‡çš„ãªæ§‹æˆã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®é©åˆ‡ãªç®¡ç†ãŒé‡è¦ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€è¤‡æ•°SPAã®é…ä¿¡ã«ãŠã‘ã‚‹å•é¡Œç‚¹ã¨ãã®è§£æ±ºç­–ã€ã•ã‚‰ã«Lambda@Edgeã‚’ä½¿ç”¨ã—ãŸé…ä¿¡æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## åŸºæœ¬çš„ãªæ§‹æˆã¨å•é¡Œç‚¹

### æ§‹æˆæ¦‚è¦

1. è¤‡æ•°ã®S3ãƒã‚±ãƒƒãƒˆï¼ˆä¾‹ï¼š`bucket-1`ã€`bucket-2`ï¼‰ã«SPAã‚’ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°
2. 1ã¤ã®CloudFrontãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ã®ãƒã‚±ãƒƒãƒˆã‚’é…ä¿¡
3. CloudFrontã®ãƒ“ãƒ˜ã‚¤ãƒ“ã‚¢è¨­å®šã§å„ãƒã‚±ãƒƒãƒˆã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®šç¾©
4. CloudFront Functionã‚’ä½¿ç”¨ã—ã¦ã€æ‹¡å¼µå­ãªã—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’`/index.html`ã«å¤‰æ›´

### ç™ºç”Ÿã—ã†ã‚‹å•é¡Œ

ã“ã®åŸºæœ¬çš„ãªæ§‹æˆã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå•é¡ŒãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

1. ç•°ãªã‚‹ãƒ‘ã‚¹ï¼ˆä¾‹ï¼š`/bucket-1/page`ã¨`/page`ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒåŒã˜`index.html`ã‚’è¿”ã™
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ä¸é©åˆ‡ãªç®¡ç†ã«ã‚ˆã‚‹æ„å›³ã—ãªã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é…ä¿¡

## å•é¡Œã®åŸå› ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ç†è§£

CloudFrontã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã¯é€šå¸¸ã€ä»¥ä¸‹ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¾ã™ï¼š

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ›ã‚¹ãƒˆå
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹
- ã‚¯ã‚¨ãƒªæ–‡å­—åˆ—ï¼ˆè¨­å®šã«ã‚ˆã‚‹ï¼‰
- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆè¨­å®šã«ã‚ˆã‚‹ï¼‰

CloudFront Functionã§å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’`/index.html`ã«å¤‰æ›´ã™ã‚‹ã¨ã€ç•°ãªã‚‹ã‚ªãƒªã‚¸ãƒ³ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚‚åŒã˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã€æ„å›³ã—ãªã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¿”ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## è§£æ±ºç­–ï¼šLambda@Edgeã®æ´»ç”¨

### Lambda@Edgeé–¢æ•°ã®å®Ÿè£…ä¾‹

```javascript
exports.handler = async (event) => {
    const { request } = event.Records[0].cf;
    const uri = request.uri;

    if (!uri.includes('.')) {
        request.uri = '/index.html';
    } else if (uri.startsWith('/bucket-1')) {
        request.uri = request.uri.replace(/^\/bucket-1/, '');
    }

    return request;
};
```

ã“ã®å®Ÿè£…ã«ã‚ˆã‚Šã€æ‹¡å¼µå­ãªã—ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é©åˆ‡ãªå‡¦ç†ã¨ã€ç‰¹å®šã®ãƒ‘ã‚¹ã®æ­£ç¢ºãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚

1. CloudFrontã§è¤‡æ•°ã®SPAã‚’é…ä¿¡ã™ã‚‹éš›ã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æŒ™å‹•ã«æ³¨æ„ãŒå¿…è¦
2. Lambda@Edgeã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚±ãƒ¼ã‚¹ã«ãŠã‘ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã‚’è§£æ±ºå¯èƒ½

## å‚è€ƒè³‡æ–™

- [Lambda@Edgeã®ä½¿ç”¨ï¼ˆAWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/lambda-at-the-edge.html)
- [CloudFrontã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‹•ä½œã‚’åˆ¶å¾¡ã™ã‚‹ï¼ˆAWSå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰](https://docs.aws.amazon.com/ja_jp/AmazonCloudFront/latest/DeveloperGuide/controlling-the-cache-key.html)
- [Deploying Multiple SPAs using AWS CloudFront and S3 with Lambda@Edge as Pseudo Reverse Proxyï¼ˆè‹±èªï¼‰](https://medium.com/@yatharthagoenka/deploying-multiple-spas-using-aws-cloudfront-and-s3-with-lamda-edge-as-pseudo-reverse-proxy-8f6314531885)
